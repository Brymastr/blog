#!/usr/bin/env bash

export NODE_ENV=production

rm -f posts.json && touch posts.json

docker-compose up -d --build

sleep 1

function getFileSize {
  fileSize=$(wc -c posts.json | awk '{print $1}')
  echo $fileSize
}

attempts=0
maxAttempts=25
while ! [ -s posts.json ] && [ $attempts -le $maxAttempts ]; do
  getFileSize
  attempts+=1
  echo "waiting for posts to be exported..."
  sleep 1
done

getFileSize

echo "got posts"

docker-compose logs --no-color >& logs.txt
docker-compose down

# next build && next export -o dist
